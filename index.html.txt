<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MaskurCoustic Premium Store</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;800&display=swap" rel="stylesheet">
<style>
body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: black; color: white; }
.custom-scrollbar::-webkit-scrollbar { width: 5px; }
.custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
.custom-scrollbar::-webkit-scrollbar-thumb { background: #333; border-radius: 10px; }
.no-scrollbar::-webkit-scrollbar { display: none; }
.shake { animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both; }
@keyframes shake {
10%, 90% { transform: translate3d(-1px, 0, 0); }
20%, 80% { transform: translate3d(2px, 0, 0); }
30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
40%, 60% { transform: translate3d(4px, 0, 0); }
}
.product-card:hover { transform: translateY(-8px); }
</style>
</head>
<body class="selection:bg-amber-500 selection:text-black">

<div id="app">
<!-- Header -->
<header class="border-b border-neutral-800 bg-black/90 backdrop-blur-xl sticky top-0 z-50 h-20 flex items-center px-6">
<div class="max-w-7xl mx-auto w-full flex justify-between items-center">
<div class="flex items-center gap-3">
<div class="bg-amber-500 p-2.5 rounded-xl shadow-[0_0_15px_rgba(245,158,11,0.4)]">
<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="black" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 18V5l12-2v13"></path><circle cx="6" cy="18" r="3"></circle><circle cx="18" cy="16" r="3"></circle></svg>
</div>
<h1 class="text-xl font-black italic tracking-tighter uppercase">MASKUR<span class="text-amber-500">COUSTIC</span></h1>
</div>
<button id="role-toggle" class="px-6 py-2.5 rounded-2xl text-[10px] font-black uppercase flex items-center gap-2 transition-all duration-500 bg-neutral-900 text-neutral-500 border border-neutral-800">
<span id="role-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="18" height="11" x="3" y="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg></span>
<span id="role-text">admin#356</span>
</button>
</div>
</header>

<main class="max-w-7xl mx-auto px-6 py-8">
<!-- Tampilan Klien -->
<div id="client-view" class="space-y-12">
<section class="relative h-[450px] rounded-[3.5rem] overflow-hidden shadow-2xl">
<img src="https://images.unsplash.com/photo-1511379938547-c1f69419868d?auto=format&fit=crop&q=80&w=1400" class="w-full h-full object-cover brightness-[0.4]" alt="Hero">
<div class="absolute inset-0 bg-gradient-to-t from-black via-black/20 to-transparent"></div>
<div class="absolute inset-0 flex flex-col justify-end p-12">
<span class="text-amber-500 font-black text-[10px] uppercase tracking-[0.6em] mb-4">Galeri Masterpiece</span>
<h2 class="text-6xl lg:text-7xl font-black italic uppercase leading-none tracking-tighter">PERALATAN<br/><span class="text-amber-500">MAESTRO</span></h2>
<p class="text-neutral-400 mt-6 max-w-lg text-sm leading-relaxed">Koleksi instrumen premium yang dikurasi khusus untuk jiwa seni tinggi. Pilih, nego harganya, dan buat mahakarya Anda sendiri.</p>
</div>
</section>

<!-- Product Filter Tags (Visual Only) -->
<div class="flex gap-4 overflow-x-auto no-scrollbar pb-2">
<button class="px-6 py-2 rounded-full bg-amber-500 text-black text-[10px] font-black uppercase whitespace-nowrap">Semua</button>
<button class="px-6 py-2 rounded-full bg-neutral-900 border border-neutral-800 text-neutral-400 text-[10px] font-black uppercase whitespace-nowrap">Gitar & Bass</button>
<button class="px-6 py-2 rounded-full bg-neutral-900 border border-neutral-800 text-neutral-400 text-[10px] font-black uppercase whitespace-nowrap">Keyboard & Synth</button>
<button class="px-6 py-2 rounded-full bg-neutral-900 border border-neutral-800 text-neutral-400 text-[10px] font-black uppercase whitespace-nowrap">Drum & Perkusi</button>
</div>

<div id="product-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
<!-- Produk dimasukkan via JS -->
</div>

<div class="bg-neutral-900/40 border border-neutral-800 rounded-[4rem] p-10 flex flex-col lg:flex-row gap-10">
<div class="lg:w-1/3">
<h3 class="text-2xl font-black italic mb-2 uppercase">LOBI NEGO</h3>
<p class="text-[10px] text-neutral-500 uppercase tracking-widest mb-8">Diskusikan penawaran terbaik Anda</p>
<div id="client-order-list" class="space-y-3">
<!-- Daftar pesanan klien -->
</div>
</div>
<div class="lg:w-2/3">
<div class="bg-black/40 border border-neutral-800 rounded-[3rem] h-[500px] flex flex-col overflow-hidden">
<div id="chat-messages" class="flex-1 p-8 space-y-4 overflow-y-auto custom-scrollbar">
<div class="h-full flex flex-col items-center justify-center opacity-20 text-center">
<svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="mb-4"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>
<p class="text-[10px] font-black uppercase tracking-widest">Pilih Kamar Nego di Samping</p>
</div>
</div>
<div class="p-6 flex gap-3 bg-neutral-900/30 border-t border-neutral-800">
<input id="chat-input" class="flex-1 bg-black/60 border border-neutral-800 rounded-2xl px-6 outline-none text-xs text-white focus:border-amber-500 transition-colors" placeholder="Ajukan penawaran Anda...">
<button id="send-btn" class="p-4 bg-amber-500 text-black rounded-2xl hover:scale-105 active:scale-95 transition-all">
<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
</button>
</div>
</div>
</div>
</div>
</div>

<!-- Tampilan Admin -->
<div id="admin-view" class="hidden grid grid-cols-1 lg:grid-cols-12 gap-8">
<div class="lg:col-span-4 bg-neutral-900/50 border border-neutral-800 rounded-[2.5rem] p-6 h-fit">
<h2 class="text-[10px] font-black uppercase text-amber-500 tracking-[0.3em] mb-6">Manajemen Pesanan</h2>
<div id="admin-order-list" class="space-y-4 max-h-[70vh] overflow-y-auto custom-scrollbar"></div>
</div>
<div class="lg:col-span-8 flex flex-col h-[75vh]">
<div class="bg-neutral-900 border border-neutral-800 rounded-[3rem] flex-1 flex flex-col overflow-hidden">
<div class="p-8 border-b border-neutral-800 bg-neutral-800/20 flex justify-between items-center">
<h3 id="admin-chat-title" class="text-sm font-bold tracking-tight">Pilih Chat Klien</h3>
<span class="text-[9px] bg-green-500/10 text-green-500 px-3 py-1 rounded-full font-black uppercase">Live Nego</span>
</div>
<div id="admin-chat-messages" class="flex-1 p-8 space-y-4 overflow-y-auto custom-scrollbar"></div>
<div class="p-6 bg-neutral-900 border-t border-neutral-800 flex gap-3">
<input id="admin-chat-input" class="flex-1 bg-black border border-neutral-800 rounded-2xl px-6 outline-none text-xs" placeholder="Balas penawaran...">
<button id="admin-send-btn" class="p-4 bg-amber-500 text-black rounded-2xl hover:scale-105 transition-all">
<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
</button>
</div>
</div>
</div>
</div>
</main>

<!-- Modals -->
<div id="pin-modal" class="hidden fixed inset-0 bg-black/95 backdrop-blur-xl z-[100] flex items-center justify-center p-6">
<div class="bg-neutral-900 border border-neutral-800 w-full max-w-sm rounded-[3rem] p-12 text-center shadow-2xl">
<h2 class="text-2xl font-black italic mb-8 uppercase">Akses <span class="text-amber-500">Privat</span></h2>
<p class="text-[9px] text-neutral-500 uppercase tracking-widest mb-6">Masukkan PIN Keamanan Admin</p>
<input id="pin-input" type="password" maxLength="4" class="w-full bg-black border-2 border-neutral-800 rounded-2xl py-6 text-center text-4xl font-mono tracking-widest mb-10 outline-none focus:border-amber-500 text-amber-500 transition-all" placeholder="****">
<button id="pin-submit" class="w-full bg-white text-black py-5 rounded-2xl font-black uppercase text-xs hover:bg-amber-500 transition-all">Verifikasi Identitas</button>
<button onclick="document.getElementById('pin-modal').classList.add('hidden')" class="mt-6 text-[9px] text-neutral-600 uppercase font-bold">Batal</button>
</div>
</div>

<div id="cart-modal" class="hidden fixed inset-0 bg-black/95 backdrop-blur-xl z-[90] flex items-center justify-center p-6">
<div class="bg-neutral-900 border border-neutral-800 w-full max-w-md rounded-[4rem] p-12">
<h4 class="text-2xl font-black italic uppercase mb-8">Pilihan <span class="text-amber-500">Anda</span></h4>
<div id="cart-items" class="space-y-4 mb-10 max-h-[40vh] overflow-y-auto custom-scrollbar"></div>
<div class="flex justify-between mb-10 border-t border-neutral-800 pt-8 items-center">
<span class="text-[10px] text-neutral-500 uppercase font-black">Total Estimasi</span>
<span id="cart-total" class="text-2xl font-mono text-amber-500 font-bold">Rp 0</span>
</div>
<button id="checkout-btn" class="w-full bg-white text-black font-black py-6 rounded-3xl text-xs uppercase hover:bg-amber-500 transition-all shadow-[0_0_30px_rgba(255,255,255,0.1)]">Mulai Nego Sekarang</button>
<button id="close-cart" class="w-full mt-4 text-[10px] text-neutral-500 uppercase font-bold">Tambah Produk Lain</button>
</div>
</div>
</div>

<!-- Firebase & Logic -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, query, orderBy, getDoc } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";
import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";

const firebaseConfig = JSON.parse(__firebase_config);
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);
const appId = typeof __app_id !== 'undefined' ? __app_id : 'maskur-coustic-shop';
const apiKey = "";
const ADMIN_PIN = "1234";

let user = null;
let role = 'client';
let cart = [];
let activeRoomId = null;

// TTS Utility
async function speak(text) {
try {
const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`, {
method: 'POST',
headers: { 'Content-Type': 'application/json' },
body: JSON.stringify({
contents: [{ parts: [{ text: text }] }],
generationConfig: {
responseModalities: ["AUDIO"],
speechConfig: {
voiceConfig: {
prebuiltVoiceConfig: { voiceName: "Kore" }
}
}
}
})
});

if (!response.ok) throw new Error('TTS API Error');

const result = await response.json();
const pcmData = result.candidates[0].content.parts[0].inlineData.data;
const audioBlob = base64ToWavBlob(pcmData, 24000);
const audioUrl = URL.createObjectURL(audioBlob);
const audio = new Audio(audioUrl);
audio.play();
} catch (error) {
console.error("TTS Gagal:", error);
}
}

function base64ToWavBlob(base64, sampleRate) {
const binaryString = atob(base64);
const bytes = new Uint8Array(binaryString.length);
for (let i = 0; i < binaryString.length; i++) bytes[i] = binaryString.charCodeAt(i);
const buffer = new ArrayBuffer(44 + bytes.length);
const view = new DataView(buffer);
const writeString = (offset, string) => {
for (let i = 0; i < string.length; i++) view.setUint8(offset + i, string.charCodeAt(i));
};
writeString(0, 'RIFF');
view.setUint32(4, 32 + bytes.length, true);
writeString(8, 'WAVE');
writeString(12, 'fmt ');
view.setUint32(16, 16, true);
view.setUint16(20, 1, true);
view.setUint16(22, 1, true);
view.setUint32(24, sampleRate, true);
view.setUint32(28, sampleRate * 2, true);
view.setUint16(32, 2, true);
view.setUint16(34, 16, true);
writeString(36, 'data');
view.setUint32(40, bytes.length, true);
for (let i = 0; i < bytes.length; i++) view.setUint8(44 + i, bytes[i]);
return new Blob([buffer], { type: 'audio/wav' });
}

// Expanded Products (20 items)
const products = [
// Gitar & Bass
{ id: 1, name: 'Fender Strat Am Pro II', price: 28500000, img: 'https://images.unsplash.com/photo-1550291652-6ea9114a47b1?auto=format&fit=crop&q=80&w=800' },
{ id: 2, name: 'Gibson Les Paul Standard', price: 42000000, img: 'https://images.unsplash.com/photo-1516924962500-2b4b3b99ea02?auto=format&fit=crop&q=80&w=800' },
{ id: 6, name: 'Fender Precision Bass 51', price: 34000000, img: 'https://www.andybaxterbass.com/cdn/shop/files/IMG_6398-2_480x480.jpg' },
{ id: 7, name: 'Taylor 814ce Acoustic', price: 62000000, img:'https://r2.gear4music.com/media/41/413505/600/preview.jpg' },
{ id: 11, name: 'Ibanez JEM77P Steve Vai', price: 24500000, img: 'https://guitargeargiveaway.co.uk/wp-content/uploads/2023/12/Ibanez-JEM77P-Steve-Vai-JEM-in-Blue-Floral-Pattern-3.jpg' },
{ id: 12, name: 'PRS Custom 24 Blue Matte', price: 58000000, img: 'https://images.unsplash.com/photo-1550985616-10810253b84d?auto=format&fit=crop&q=80&w=800' },
{ id: 13, name: 'Music Man StingRay Special', price: 39500000, img:'https://s3-us-west-2.amazonaws.com/static.music-man.com/website/images/instruments/heroes-mobile/slide-74.jpg?1743443495' },

// Keyboard & Synth
{ id: 4, name: 'Steinway & Sons Model D', price: 2900000000, img: 'https://images.unsplash.com/photo-1520523839897-bd0b52f945a0?auto=format&fit=crop&q=80&w=800' },
{ id: 5, name: 'Sequential Prophet-5', price: 65000000, img: 'https://images.unsplash.com/photo-1598488035139-bdbb2231ce04?auto=format&fit=crop&q=80&w=800' },
{ id: 10, name: 'Moog Matriarch Synth', price: 38000000, img:'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSfYcwOY4oHuMnF_UaDv9LZCo68pa5BYNDSQA&s' },
{ id: 14, name: 'Korg Kronos 2 Workstation', price: 47000000, img:'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcToBTal4Yr736DNdoNQP2xtMPvzdQffM9ieQA&s' },
{ id: 15, name: 'Nord Stage 4 88-Key', price: 72000000, img: 'https://images.unsplash.com/photo-1552422535-c45813c61732?auto=format&fit=crop&q=80&w=800' },
{ id: 16, name: 'Arturia PolyBrute 12', price: 52000000, img:'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcR40t_XYrWMjOKZrm85Ry4T2-OJO0KcwtWG5g&s' },

// Drum & Perkusi
{ id: 3, name: 'Roland TD-27KV V-Drums', price: 54000000, img: 'https://images.unsplash.com/photo-1519892300165-cb5542fb47c7?auto=format&fit=crop&q=80&w=800' },
{ id: 8, name: 'Ludwig Vistalite Zep Set', price: 85000000, img: 'https://images.unsplash.com/photo-1543443374-b6fe10a6ab7b?auto=format&fit=crop&q=80&w=800' },
{ id: 17, name: 'Pearl Export EXX Studio', price: 15500000, img:'https://queen-music.com/media/catalog/product/cache/1/image/650x/040ec09b1e35df139433887a97daa66f/p/e/pearl_exx725f_arctic_sparkle_800_1.jpg' },
{ id: 18, name: 'Zildjian K-Custom Cymbal Set', price: 22000000, img:'https://images-cdn.ubuy.co.id/68bc0468a74dff567f018e4a-zildjian-k-custom-cymbal-set-kcd900.jpg' },

// Lainnya & Tiup
{ id: 9, name: 'Selmer Paris Saxophone', price: 125000000, img: 'https://images.unsplash.com/photo-1528143358888-6d3c7f67bd5d?auto=format&fit=crop&q=80&w=800' },
{ id: 19, name: 'Stradivarius Copy Cello', price: 185000000, img:'https://www.violin-store.com/00123/product/images/30/ssf124.jpg' },
{ id: 20, name: 'Yamaha YTR-8335G Trumpet', price: 31000000, img: 'https://images.unsplash.com/photo-1573871666457-7c7329118cf9?auto=format&fit=crop&q=80&w=800' }
];

const formatIDR = (n) => new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', maximumFractionDigits: 0 }).format(n);

// Auth
const initAuth = async () => {
if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
await signInWithCustomToken(auth, __initial_auth_token);
} else {
await signInAnonymously(auth);
}
};

onAuthStateChanged(auth, (u) => {
if (u) {
user = u;
renderProducts();
listenOrders();
setupListeners();
}
});

initAuth();

function renderProducts() {
const grid = document.getElementById('product-grid');
grid.innerHTML = products.map(p => `
<div class="product-card group bg-neutral-900/30 border border-neutral-800 rounded-[3rem] overflow-hidden flex flex-col transition-all duration-500 hover:border-amber-500/50 hover:bg-neutral-900/60">
<div class="h-56 overflow-hidden relative">
<img src="${p.img}" class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-1000 grayscale-[0.2] group-hover:grayscale-0">
<div class="absolute inset-0 bg-gradient-to-t from-black/80 to-transparent opacity-0 group-hover:opacity-100 transition-opacity"></div>
</div>
<div class="p-8 flex flex-col flex-1">
<h3 class="font-black text-[11px] uppercase tracking-tight mb-4 flex-1 leading-relaxed">${p.name}</h3>
<div class="flex justify-between items-end">
<div class="flex flex-col">
<span class="text-[8px] text-neutral-500 uppercase font-black tracking-widest mb-1">Investasi</span>
<span class="text-[11px] font-mono text-amber-500 font-bold">${formatIDR(p.price)}</span>
</div>
<button onclick="addToCart(${p.id})" class="p-4 bg-white text-black rounded-2xl hover:bg-amber-500 transition-all hover:rotate-3 shadow-lg">
<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4Z"/><path d="M3 6h18"/><path d="M16 10a4 4 0 0 1-8 0"/></svg>
</button>
</div>
</div>
</div>
`).join('');
}

window.addToCart = (id) => {
const p = products.find(x => x.id === id);
cart.push(p);
updateCartUI();
document.getElementById('cart-modal').classList.remove('hidden');
};

function updateCartUI() {
const itemsDiv = document.getElementById('cart-items');
itemsDiv.innerHTML = cart.map((i, idx) => `
<div class="flex gap-4 items-center bg-black/40 p-5 rounded-3xl border border-neutral-800 group">
<img src="${i.img}" class="w-16 h-16 object-cover rounded-2xl">
<div class="flex-1">
<p class="text-[10px] font-black uppercase leading-tight">${i.name}</p>
<p class="text-[9px] text-amber-500 font-mono mt-1">${formatIDR(i.price)}</p>
</div>
<button onclick="removeFromCart(${idx})" class="text-neutral-600 hover:text-red-500 p-2 transition-colors">
<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>
</button>
</div>
`).join('');
document.getElementById('cart-total').innerText = formatIDR(cart.reduce((s, x) => s + x.price, 0));
}

window.removeFromCart = (idx) => {
cart.splice(idx, 1);
updateCartUI();
if(cart.length === 0) document.getElementById('cart-modal').classList.add('hidden');
};

async function placeOrder() {
if (!user || cart.length === 0) return;
const orderData = {
items: cart,
status: 'menunggu',
totalPrice: cart.reduce((s, x) => s + x.price, 0),
clientUid: user.uid,
timestamp: Date.now()
};
const colRef = collection(db, 'artifacts', appId, 'public', 'data', 'orders');
const docRef = await addDoc(colRef, orderData);
activeRoomId = docRef.id;
cart = [];
document.getElementById('cart-modal').classList.add('hidden');
speak("Pesanan sudah diterima. Yuk, tawar harganya di lobi nego sekarang agar saya bisa proses.");
listenChats();
}

function listenOrders() {
if (!user) return;
const colRef = collection(db, 'artifacts', appId, 'public', 'data', 'orders');
onSnapshot(colRef, (snap) => {
const orders = snap.docs.map(d => ({ id: d.id, ...d.data() })).sort((a,b) => b.timestamp - a.timestamp);

// Admin Side UI
document.getElementById('admin-order-list').innerHTML = orders.map(o => `
<div class="p-6 rounded-[2rem] border transition-all ${activeRoomId === o.id ? 'bg-neutral-800 border-amber-500' : 'bg-black/50 border-neutral-800'}">
<div class="flex justify-between items-center mb-4">
<span class="text-[8px] font-black px-2 py-1 rounded-md uppercase ${o.status === 'dikirim' ? 'bg-green-500/20 text-green-500' : 'bg-amber-500/20 text-amber-500'}">${o.status}</span>
<span class="text-[8px] font-mono text-neutral-500">${new Date(o.timestamp).toLocaleTimeString()}</span>
</div>
<p class="text-[10px] font-black uppercase truncate mb-5">${o.items.map(i => i.name).join(', ')}</p>
<div class="flex gap-2">
<button onclick="setActiveRoom('${o.id}')" class="flex-1 bg-neutral-800 p-3 rounded-xl text-[9px] font-black hover:bg-neutral-700">CHAT</button>
${o.status === 'menunggu' ? `<button onclick="accOrder('${o.id}')" class="flex-1 bg-amber-500 text-black p-3 rounded-xl text-[9px] font-black uppercase shadow-lg">SETUJU</button>` : ''}
</div>
</div>
`).join('');

// Client Side UI
document.getElementById('client-order-list').innerHTML = orders.filter(o => o.clientUid === user.uid).map(o => `
<button onclick="setActiveRoom('${o.id}')" class="w-full p-6 rounded-[2rem] border text-left transition-all ${activeRoomId === o.id ? 'bg-amber-500 text-black border-amber-500' : 'bg-black/40 border-neutral-800 text-neutral-400'} group">
<p class="text-[10px] font-black uppercase italic group-hover:tracking-widest transition-all">Lobi #${o.id.slice(-4)}</p>
<p class="text-[9px] font-mono mt-2">${formatIDR(o.totalPrice)} • <span class="uppercase">${o.status}</span></p>
</button>
`).join('');

// Voice Trigger Logic
snap.docChanges().forEach(change => {
if (change.type === "added" && role === 'admin' && !snap.metadata.hasPendingWrites) {
speak("Bos Maskur, ada pesanan baru yang harus dipantau. Silakan cek daftar pesanan.");
}
if (change.type === "modified" && role === 'client' && !snap.metadata.hasPendingWrites) {
const data = change.doc.data();
if (data.clientUid === user.uid && data.status === 'dikirim') {
speak("Kabar gembira! Harga yang kamu tawar sudah disetujui. Produk premium kamu segera meluncur.");
}
}
});
}, (e) => console.error(e));
}

window.setActiveRoom = (id) => {
activeRoomId = id;
if (role === 'admin') document.getElementById('admin-chat-title').innerText = `Negosiasi ID: ${id.slice(-8).toUpperCase()}`;
listenChats();
};

window.accOrder = async (id) => {
await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'orders', id), { status: 'dikirim' });
};

function listenChats() {
if (!user || !activeRoomId) return;
const colRef = collection(db, 'artifacts', appId, 'public', 'data', 'chats');
onSnapshot(colRef, (snap) => {
const msgs = snap.docs.map(d => ({id: d.id, ...d.data()}))
.filter(m => m.roomId === activeRoomId)
.sort((a,b) => a.timestamp - b.timestamp);

const container = role === 'admin' ? document.getElementById('admin-chat-messages') : document.getElementById('chat-messages');
container.innerHTML = msgs.map(m => `
<div class="flex ${m.sender === role ? 'justify-end' : 'justify-start'} animate-in fade-in duration-500">
<div class="max-w-[80%] px-6 py-4 rounded-[1.8rem] text-[12px] leading-relaxed ${m.sender === role ? (role === 'admin' ? 'bg-amber-500 text-black font-semibold' : 'bg-neutral-800 border border-neutral-700') : (role === 'admin' ? 'bg-neutral-800' : 'bg-amber-500 text-black font-semibold')}">
${m.text}
<span class="block text-[7px] mt-1 opacity-50 uppercase tracking-tighter">${new Date(m.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</span>
</div>
</div>
`).join('');
container.scrollTop = container.scrollHeight;
}, (e) => {});
}

async function sendChatMessage(input) {
if (!input.value.trim() || !activeRoomId) return;
const colRef = collection(db, 'artifacts', appId, 'public', 'data', 'chats');
await addDoc(colRef, {
roomId: activeRoomId,
text: input.value,
sender: role,
timestamp: Date.now()
});
input.value = '';
}

function setupListeners() {
document.getElementById('role-toggle').onclick = () => {
if (role === 'admin') {
role = 'client';
document.getElementById('admin-view').classList.add('hidden');
document.getElementById('client-view').classList.remove('hidden');
document.getElementById('role-text').innerText = 'admin#356';
document.getElementById('role-toggle').className = 'px-6 py-2.5 rounded-2xl text-[10px] font-black uppercase flex items-center gap-2 bg-neutral-900 text-neutral-500 border border-neutral-800';
} else {
document.getElementById('pin-modal').classList.remove('hidden');
}
};

document.getElementById('pin-submit').onclick = () => {
const val = document.getElementById('pin-input').value;
if (val === ADMIN_PIN) {
role = 'admin';
document.getElementById('pin-modal').classList.add('hidden');
document.getElementById('admin-view').classList.remove('hidden');
document.getElementById('client-view').classList.add('hidden');
document.getElementById('role-text').innerText = 'BOS MASKUR';
document.getElementById('role-toggle').className = 'px-6 py-2.5 rounded-2xl text-[10px] font-black uppercase flex items-center gap-2 bg-amber-500 text-black shadow-lg shadow-amber-500/20';
document.getElementById('pin-input').value = '';
speak("Selamat datang kembali, Bos Maskur. Mari kita mulai berbisnis dan pantau pasar hari ini.");
} else {
document.getElementById('pin-modal').children[0].classList.add('shake');
setTimeout(() => document.getElementById('pin-modal').children[0].classList.remove('shake'), 500);
}
};

document.getElementById('checkout-btn').onclick = placeOrder;
document.getElementById('send-btn').onclick = () => sendChatMessage(document.getElementById('chat-input'));
document.getElementById('admin-send-btn').onclick = () => sendChatMessage(document.getElementById('admin-chat-input'));
document.getElementById('close-cart').onclick = () => document.getElementById('cart-modal').classList.add('hidden');

// Keyboard support
document.getElementById('chat-input').onkeypress = (e) => e.key === 'Enter' && sendChatMessage(e.target);
document.getElementById('admin-chat-input').onkeypress = (e) => e.key === 'Enter' && sendChatMessage(e.target);
document.getElementById('pin-input').onkeypress = (e) => e.key === 'Enter' && document.getElementById('pin-submit').click();
}
</script>
</body>
</html>